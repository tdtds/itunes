#!/usr/bin/env ruby
#coding:utf-8

#
# syncing music files with iTunes
#
# Copyright (C) 2010, TADA Tadashi <t@tdtds.jp>
# You can redistribute it and/or modify it under GPL.
#

$: << '../lib' if $DEBUG
require 'itunes'
require 'yaml'
require 'ya2yaml'

class SyncTunes
	def initialize
		begin
			@itunes = ITunes::App::new
			@conf = Config::new
		rescue WIN32OLERuntimeError
			raise RuntimeError::new( "couldn't connect to iTunes." )
		end
	end

	def default_config
		@conf.default( @itunes ).ya2yaml
	end

	def set_conf( yaml )
		yaml.sub!( /\A\xEF\xBB\xBF/, '' ) # remove BOM added by Windows Notepad.
		@conf.set_conf( YAML::load( yaml ) )
	end

	def sync
		pp @conf.list_files( @itunes )
	end
end

class Config < Hash
	def initialize
		self['music_sync'] = true
		self['music_dest'] = ''
		self['video_sync'] = false
		self['video_dest'] = ''
		self['playlists'] = []
		super
	end

	def default( itunes )
		self['music_dest'] = 'F:/Music'
		self['video_dest'] = 'F:/Video'
		itunes.each_playlist do |list|
			self['playlists'] << list.name.encode( 'UTF-8' ) if list.playlist?
		end
		self
	end

	def set_conf( conf )
		self.update( conf )
	end

	def list_files( itunes )
		file_spec = Struct::new( 'FileSpec', :name, :album, :path, :modify )
		list = {}
		self['playlists'].each do |list_name|
			tracks = []
			itunes.playlist( list_name ).each_track do |track|
				tracks << file_spec::new(
					track.name,
					track.album,
					track.location,
					track.modificationdate )
			end
			list[list_name] = tracks unless tracks.empty?
		end
		list
	end
end

if __FILE__ == $0 then
	require 'pp'
	require 'pathname'

	def err( msg_text, exit_code = nil )
		$stderr.puts "#$0: #{msg_text}"
		exit exit_code if exit_code
	end

	def msg( msg_text )
		$stderr.puts msg_text if $DEBUG
	end

	begin
		app = SyncTunes::new
		msg 'connecting to iTunes successfully.'
	rescue RuntimeError
		err $!.message, -1
	end

	if ARGV.length == 0 then
		msg 'generating default configration file and putting to stdout.'
		print app.default_config
		exit 0
	end

	msg 'loading specified configration file.'
	app.set_conf( open( Pathname::new( ARGV.shift ), 'r:UTF-8', &:read ) )

	msg 'executing sync.'
	app.sync
end

#!/usr/bin/env ruby
#coding:utf-8

#
# syncing music files with iTunes
#
# Copyright (C) 2010, TADA Tadashi <t@tdtds.jp>
# You can redistribute it and/or modify it under GPL.
#

$: << '../lib' if $DEBUG
require 'itunes'
require 'yaml'
require 'ya2yaml'

class SyncTunes
	def initialize
		begin
			@itunes = ITunes::App::new
		rescue WIN32OLERuntimeError
			raise RuntimeError::new( "couldn't connect to iTunes." )
		end
	end

	def default_config
		Config::new.default( @itunes ).ya2yaml
	end

	def set_conf( yaml )
		@conf = Config::new.set_conf( YAML::load( yaml ) )
	end
end

class Config < Hash
	def initialize
		self['dest'] = ''
		self['playlists'] = []
		super
	end

	def default( itunes )
		self['dest'] = 'F:/Music'
		itunes.each_playlist do |list|
			self['playlists'] << list.name.encode( 'UTF-8' ) if list.playlist?
		end
		self
	end

	def set_conf( conf )
		self.update( conf )
	end
end

if __FILE__ == $0 then
	require 'pp'
	require 'pathname'

	def err( msg_text, exit_code = nil )
		$stderr.puts "#$0: #{msg_text}"
		exit exit_code if exit_code
	end

	def msg( msg_text )
		$stderr.puts msg_text if $DEBUG
	end

	begin
		app = SyncTunes::new
		msg 'connecting to iTunes successfully.'
	rescue RuntimeError
		err $!.message, -1
	end

	if ARGV.length == 0 then
		msg 'generating default configration file and putting to stdout.'
		print app.default_config
		exit 0
	end

	msg 'loading specified configration file.'
	app.set_conf( Pathname::new( ARGV.shift ).read )
end
